<script>
/* global google */
const display = document.querySelector("p"),
      dataSheetLink = document.querySelector("#dataSheetLink"),
      input = document.querySelector("input"),
      app = new SpeakAndSpell()
const run = google.script.run
        .withFailureHandler(app.handleError)
          .withSuccessHandler(app.start)

// call server
run.getWords()

function SpeakAndSpell() {
  const app = this
  app.running = false
  app.words = []
  app.synth = window.speechSynthesis
  app.rates = {
    SLOW: 0.65, NORMAL: 1
  }
  app.checkSpelling = () => {
    const currentInput = input.value,
          target = app.words[app.wordIndex]
    if (currentInput.length < target.length) {
      return
    }
    if (currentInput.length > target.length) {
      app.speak("too many letters")
      return
    }
    if (currentInput.toLowerCase() !== target.toLowerCase()) {
      app.speak("you entered:")
      app.speak(currentInput, { rate: app.rates.SLOW })
      app.speak("which is not quite right. try again.")
      return
    }
    app.speak("you entered:")
    app.speak(currentInput, { rate: app.rates.SLOW })
    app.speak("that is correct", { end: app.nextWord })
  }
  app.speak = (string, options) => {
    const utter = new SpeechSynthesisUtterance(string)
    if (options && options.rate) {
      utter.rate = options.rate
    } else {
      utter.rate = app.rates.NORMAL
    }
    if (options && options.start) {
      utter.addEventListener("start", options.start)
    }
    if (options && options.end) {
      utter.addEventListener("end", options.end)
    }
    app.synth.speak(utter)
  }
  app.spell = string => {
    app.speak("spell")
    app.speak(string, {
      rate: app.rates.SLOW,
      start: () => {display.textContent = "Listen to the word"},
      end: () => {display.textContent = "Click to hear the word again"}
    })
  }
  app.nextWord = () => {
    ++app.wordIndex
    if (app.wordIndex == app.words.length) {
      app.shuffle(app.words)
      app.wordIndex = 0
    }
    app.update(app.words[app.wordIndex])
    google.script.history.push({ wordIndex: app.wordIndex })
  }
  /**
   * Goes through array once, swapping the ith element with a randomly
   *   selected element.
   * Mutates the array in place.
   * @param {object[]} words
   * @returns {void}
   */
  app.shuffle = words => {
    for (let i = 0, l = words.length; i < l; ++i) {
      let swapIndex = Math.floor(Math.random() * words.length)
      let swapValue = words[swapIndex]
      words[swapIndex] = words[i]
      words[i] = swapValue
    }
  }
  /**
   * callback function; initializes app
   * @see google.script.run
   * @param {object} response - response from server
   */
  app.start = response => {
    app.words = response.words
    if (! app.words || app.words.length == 0) {
      app.handleError(new Error("Oops, no words found! Try refreshing."))
      return
    }
    dataSheetLink.setAttribute("href", response.url)
    app.wordIndex = 0
    app.shuffle(app.words)
  }
  /** helper function to abstract the details of rendering each card */
  app.update = word => {
    input.value = ""
    input.focus()
    app.spell(word)
  }
  /** handles clicking on the word */
  app.handleClick = click => {
    if (click.target.tagName != "P") {
      return
    }
    if (! app.running) {
      app.running = true
      app.nextWord()
    } else {
      app.speak(app.words[app.wordIndex])
    }
  }

  // simple display of error to the user
  app.handleError = error => {
    display.textContent = error.message
  }

  app.handleHistory = change => {
    // TODO implement handleHistory
    if (! change.state) {
      return
    }
  }

  app.handleKeyup = keyup => {
    if (keyup.target.tagName != "INPUT") {
      if (/^\w$/.test(keyup.key)) {
        input.value += keyup.key
      }
      input.focus()
    }
    if (/^\w$/.test(keyup.key)) {
      app.speak(keyup.key)
      app.checkSpelling()
    }
  }
  
  // register event handlers
  window.addEventListener("click", app.handleClick)
  window.addEventListener("keyup", app.handleKeyup)
  google.script.history.setChangeHandler(app.handleHistory)
}


</script>
